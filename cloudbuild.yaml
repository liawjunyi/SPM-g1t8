steps:
  # Step to set up Docker Compose
  - name: "google/cloud-sdk:latest"
    entrypoint: "sh"
    args:
      - "-c"
      - |
        apt-get update && apt-get install -y docker.io jq && \
        curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose && \
        chmod +x /usr/local/bin/docker-compose
        
        secret=$(gcloud secrets versions access latest --secret=SPM)
        export POSTGRES_USER=$(echo "$secret" | jq -r '.POSTGRES_USER')
        export POSTGRES_PASSWORD=$(echo "$secret" | jq -r '.POSTGRES_PASSWORD')
        export POSTGRES_DB=$(echo "$secret" | jq -r '.POSTGRES_DB')
        export AWS_ACCESS_KEY_ID=$(echo "$secret" | jq -r '.AWS_ACCESS_KEY_ID')
        export AWS_SECRET_ACCESS_KEY=$(echo "$secret" | jq -r '.AWS_SECRET_ACCESS_KEY')
        docker-compose up --build -d
    secretEnv: ['SPM']

# Optionally, specify any secrets or additional configurations
availableSecrets:
  secretManager:
    - versionName: projects/river-tiger-440210-m6/secrets/SPM/versions/latest
      env: "SPM"

options:
  logging: CLOUD_LOGGING_ONLY
